{% extends 'community_app/base.html' %}
{% load static %}

{% block title %}{{ question.title }} - HealthConnect{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
{% endblock %}

{% block content %}
<div class="question-detail-container">
    <!-- Question -->
    <div class="card question-card">
        <div class="question-header">
            <div class="question-title-section">
                <h1 class="question-title">{{ question.title }}</h1>
                <div class="question-meta">
                    <span class="meta-item">
                        <i class="fas fa-user"></i> {{ question.user.username }}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-calendar"></i> {{ question.created_at|date:"M d, Y" }}
                    </span>
                    {% if question.category %}
                        <span class="badge badge-primary">{{ question.category.name }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="question-upvote">
                <form method="POST" action="{% url 'upvote_question' question.id %}">
                    {% csrf_token %}
                    <button type="submit" class="upvote-btn">
                        <i class="fas fa-thumbs-up upvote-icon {% if user in question.upvotes.all %}active{% endif %}"></i>
                        <span class="upvote-count">{{ question.total_upvotes }}</span>
                    </button>
                </form>
            </div>
        </div>

        <div class="question-description">
            {{ question.description|linebreaks }}
        </div>
    </div>

    <!-- Answers Section -->
    <div class="card answers-card">
        <div class="answers-header">
            <h2>{{ answers.count }} Answers</h2>
        </div>

        {% if user.is_authenticated %}
            <button onclick="toggleAnswerForm()" class="btn btn-primary mb-4">
                <i class="fas fa-plus"></i> Add Answer
            </button>

            <form id="answer-form" method="POST" class="answer-form hidden">
                {% csrf_token %}
                <div class="form-group">
                    <label for="{{ form.text.id_for_label }}" class="form-label">Your Answer</label>
                    {{ form.text }}
                    {% if form.text.errors %}
                        <div class="form-error">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ form.text.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-secondary">Submit Answer</button>
                    <button type="button" onclick="toggleAnswerForm()" class="btn btn-outline">Cancel</button>
                </div>
            </form>
        {% else %}
            <div class="auth-prompt">
                <p>
                    <a href="{% url 'login' %}">Login</a> to post an answer.
                </p>
            </div>
        {% endif %}

        <!-- Answers List -->
        <div class="answers-list">
            {% for answer in answers %}
                <div class="answer-item">
                    <div class="answer-header">
                        <div class="answer-user">
                            <div class="user-info">
                                <span class="username">{{ answer.user.username }}</span>
                                <span class="username">{{ answer.user.expertise }}</span>
                                <span class="answer-date">
                                    on {{ answer.created_at|date:"M d, Y" }}
                                </span>
                                {% if answer.is_expert %}
                                    <span class="badge badge-secondary">Expert</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="answer-upvote">
                            <form method="POST" action="{% url 'upvote_answer' answer.id %}">
                                {% csrf_token %}
                                <button type="submit" class="upvote-btn">
                                    <i class="fas fa-thumbs-up upvote-icon {% if user in answer.upvotes.all %}active{% endif %}"></i>
                                    <span class="upvote-count">{{ answer.total_upvotes }}</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="answer-content">
                        {{ answer.text|linebreaks }}
                    </div>
                </div>
            {% empty %}
                <div class="no-answers">
                    <i class="fas fa-comments text-muted"></i>
                    <p>No answers yet. Be the first to respond!</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    /* Question Detail Page Specific Styles */
    .question-detail-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .question-card {
        margin-bottom: var(--space-xl);
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-lg);
    }

    .question-title-section {
        flex: 1;
    }

    .question-title {
        font-size: var(--font-size-2xl);
        font-weight: 600;
        margin-bottom: var(--space-sm);
        color: var(--text-color);
        line-height: 1.3;
    }

    .question-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-md);
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-xs);
    }

    .question-upvote {
        text-align: center;
    }

    .upvote-btn {
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-xs);
        padding: var(--space-sm);
        border-radius: var(--radius-md);
        transition: background-color var(--transition-fast);
    }

    .upvote-btn:hover {
        background-color: var(--border-color);
    }

    .upvote-icon {
        font-size: var(--font-size-xl);
        color: var(--text-muted);
        transition: color var(--transition-fast);
    }

    .upvote-icon.active {
        color: var(--primary-color);
    }

    .upvote-count {
        font-size: var(--font-size-sm);
        font-weight: 500;
        color: var(--text-color);
    }

    .question-description {
        line-height: 1.6;
        color: var(--text-color);
        font-size: var(--font-size-base);
    }

    .question-description p {
        margin-bottom: var(--space-md);
    }

    /* Answers Card */
    .answers-card {
        padding: var(--space-xl);
    }

    .answers-header {
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 2px solid var(--border-color);
    }

    .answers-header h2 {
        font-size: var(--font-size-xl);
        font-weight: 600;
        margin-bottom: 0;
    }

    /* Answer Form */
    .answer-form {
        background-color: #f8fafc;
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-xl);
        border: 1px solid var(--border-color);
    }

    .answer-form.hidden {
        display: none;
    }

    /* Auth Prompt */
    .auth-prompt {
        background-color: #f8fafc;
        padding: var(--space-md);
        border-radius: var(--radius-md);
        text-align: center;
        margin-bottom: var(--space-lg);
        border: 1px solid var(--border-color);
    }

    .auth-prompt p {
        margin: 0;
    }

    .auth-prompt a {
        color: var(--primary-color);
        font-weight: 500;
    }

    /* Answers List */
    .answers-list {
        margin-top: var(--space-xl);
    }

    .answer-item {
        padding: var(--space-lg);
        border-bottom: 1px solid var(--border-color);
    }

    .answer-item:last-child {
        border-bottom: none;
    }

    .answer-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-md);
    }

    .answer-user {
        flex: 1;
    }

    .user-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: var(--space-sm);
    }

    .username {
        font-weight: 600;
        color: var(--text-color);
    }

    .answer-date {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
    }

    .answer-content {
        line-height: 1.6;
        color: var(--text-color);
    }

    .answer-content p {
        margin-bottom: var(--space-md);
    }

    /* No Answers */
    .no-answers {
        text-align: center;
        padding: var(--space-xl);
        color: var(--text-muted);
    }

    .no-answers i {
        font-size: 3em;
        margin-bottom: var(--space-md);
    }

    .no-answers p {
        margin: 0;
        font-size: var(--font-size-lg);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .question-header {
            flex-direction: column;
            gap: var(--space-md);
        }

        .question-upvote {
            align-self: flex-start;
        }

        .answer-header {
            flex-direction: column;
            gap: var(--space-md);
        }

        .user-info {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-xs);
        }
    }

    @media (max-width: 480px) {
        .question-meta {
            flex-direction: column;
            gap: var(--space-xs);
        }

        .answers-card {
            padding: var(--space-lg);
        }

        .answer-item {
            padding: var(--space-md);
        }
    }
</style>

<script>
    function toggleAnswerForm() {
        const form = document.getElementById('answer-form');
        const isHidden = form.classList.contains('hidden');

        if (isHidden) {
            form.classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            form.querySelector('textarea').focus();
        } else {
            form.classList.add('hidden');
        }
    }

    // Initialize form textarea with proper classes
    document.addEventListener('DOMContentLoaded', function() {
        const answerTextarea = document.querySelector('#answer-form textarea');
        if (answerTextarea) {
            answerTextarea.classList.add('form-control', 'form-textarea');
            answerTextarea.placeholder = 'Share your experience, advice, or suggestions...';
            answerTextarea.rows = 6;
        }

        // Add timestamp tooltips
        document.querySelectorAll('.meta-item, .answer-date').forEach(element => {
            const dateText = element.textContent;
            element.setAttribute('title', dateText);
            element.style.cursor = 'help';
        });
    });
</script>
{% endblock %}